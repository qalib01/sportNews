let createBtn=document.querySelector("#createBtn"),editBtn=document.querySelectorAll(".editBtn"),deleteForm=document.querySelector("#deleteForm"),basicForm=document.querySelector("#basicForm");const submitterSave=document.querySelector("button[value=save]");let alertMessage=document.querySelector("#alert-message"),timeout=4e3;const azerbaijaniToEnglishMap={ə:"e",ı:"i",ö:"o",ğ:"g",ü:"u",ş:"s",ç:"c","-":"-",_:""," ":"-",'"':"","'":"",":":"",";":"",",":"",".":"","“":"","”":"","?":"","!":"",".":"",",":"","/":""};function changeLetters(e){return e.replace(/[əıöğüşç\s\-_'"':;,.“”?!.,/]/g,e=>azerbaijaniToEnglishMap[e])}function showAlert(e,t,a){if(alertMessage){let i=alertMessage.querySelector("i"),r=alertMessage.querySelector("p");i.classList="success"===t?"bx bx-check-circle":"bx bxs-error",r.textContent=e,alertMessage.style.display=a?"flex":"none",alertMessage.classList.remove("error","success"),t&&alertMessage.classList.add(t)}setTimeout(()=>{showAlert("","",!1)},timeout)}function attachEditDeleteEventListeners(){let e=document.querySelectorAll(".editBtn"),t=document.querySelectorAll(".deleteBtn");t&&t.forEach(e=>{e.addEventListener("click",async()=>{let t=e.getAttribute("data-action");deleteForm.action=t})}),e&&e.forEach(e=>{e.addEventListener("click",async t=>{basicForm.reset();let a=e.getAttribute("data-action"),i=e.getAttribute("data-item"),r=e.getAttribute("data-id");basicForm.action=a;let s=JSON.parse(await (await fetch(`/admin/selected-${i}?id=${r}`)).text());if("news"==i){basicForm.title.value=s.title,editorInstance.setData(s.content),basicForm.status.value=+s.status,basicForm.headNews.value=+s.isHeadNews,basicForm.category.value=s.categoryId,basicForm.userMetaKeywords.value=s.metaKeywords;var n=document.getElementById("category"),o=new Event("change");n.dispatchEvent(o),basicForm.subCategory.value=s.subCategoryId;let c=s.sharedAt,l=new Date(c.replaceAll("Z","")),d=new Intl.DateTimeFormat("az-AZ",{hour:"2-digit",minute:"2-digit"}),m=d.format(l);basicForm.time.value=m;let u=new Intl.DateTimeFormat("az-AZ",{day:"2-digit",month:"2-digit",year:"numeric"}),b=u.format(l);basicForm.date.value=b,document.querySelectorAll('input[type="checkbox"][id="tag"]').forEach(function(e){s.news_tags.forEach(t=>{e.value===t.tagId&&(e.checked=!0)})})}})})}createBtn&&createBtn.addEventListener("click",()=>{basicForm.reset();let e=createBtn.getAttribute("data-action");basicForm.action=e}),editBtn&&editBtn.forEach(e=>{e.addEventListener("click",async t=>{basicForm.reset();let a=e.getAttribute("data-action"),i=e.getAttribute("data-item"),r=e.getAttribute("data-id");basicForm.action=a;let s=JSON.parse(await (await fetch(`/admin/selected-${i}?id=${r}`)).text());"user"==i?(basicForm.name.value=s.name,basicForm.surname.value=s.surname,basicForm.email.value=s.email,basicForm.status.value=+s.status):"social_media"==i?(basicForm.name.value=s.name,basicForm.linkSlug.value=s.linkSlug,basicForm.socialMediaId.value=s.socialMediaId,basicForm.status.value=+s.status):(basicForm.name.value=s.name,basicForm.description.innerHTML=s.description,basicForm.status.value=+s.status,basicForm.category&&(basicForm.category.value=s.categoryId),basicForm.inOrder&&(basicForm.inOrder.value=s.inOrder))})}),attachEditDeleteEventListeners();const itemFormCreateUpdate=async e=>{try{let t=basicForm.name.value.trim(),a=basicForm.description.value.trim(),i=basicForm.status.value.trim(),r=changeLetters(t.toLowerCase()),s,n;basicForm.category&&(s=basicForm.category.value.trim()),basicForm.inOrder&&(n=basicForm.inOrder.value.trim());let o={name:t,description:a,categoryId:s,status:i,inOrder:n,key:r};res=await fetch(basicForm.action,{method:e,body:JSON.stringify(o),headers:{"Content-type":"application/json"}}).then(async e=>{let t=await e.json();showAlert(t.message,t.key,!0),200==e.status&&location.reload()})}catch(c){return c}},newsFormCreateUpdate=async e=>{try{let t=basicForm.title.value.trim(),a=basicForm.category.value.trim(),i=basicForm.subCategory.value.trim(),r=document.querySelector("#img");r=r.files[0];let s=editorInstance.getData().trim(),n=[],o=basicForm.userMetaKeywords.value.trim(),c=o&&o.split(",").map(e=>e.trim()),l=s&&s.replace(/<[^>]*>/g,""),d=l&&l.match(/"([^"]+)"/g),m=[];d&&d.map(function(e){return e.replace(/['"]/g,"").trim()}),c&&c.forEach(e=>{m.push(e)}),"Se\xe7im edin"!=basicForm.category.value.trim()&&m.push(basicForm.category.options[basicForm.category.selectedIndex].textContent.trim()),"Se\xe7im edin"!=basicForm.subCategory.value.trim()&&m.push(basicForm.subCategory.options[basicForm.subCategory.selectedIndex].textContent.trim()),document.querySelectorAll('input[type="checkbox"][id="tag"]').forEach(function(e){e.checked&&(n.push(e.value),m.push(e.nextElementSibling.textContent.trim()))});let u=basicForm.date.value.trim(),b=basicForm.time.value.trim(),g=[],p=new Set(m);Array.from(p).forEach(e=>{g.push(e)});let y=`${u} ${b}`;(""==y.trim()||void 0==y.trim()||null==y.trim())&&(y=new Date);let h=basicForm.status.value.trim(),v=basicForm.headNews.value.trim(),F=changeLetters(t.toLowerCase()),w=new FormData;w.append("title",t),w.append("key",F),w.append("metaKeywords",g),w.append("categoryId",a),w.append("subCategoryId",i),w.append("content",s),w.append("status",h),w.append("isHeadNews",v),w.append("img",r),w.append("tags",n),w.append("sharedAt",y),res=await fetch(basicForm.action,{method:e,body:w}).then(async e=>{let t=await e.json();showAlert(t.message,t.key,!0),200==e.status&&location.reload()})}catch(f){return console.log(f),f}},userFormCreateUpdate=async e=>{try{let t=basicForm.name.value.trim(),a=basicForm.surname.value.trim(),i=basicForm.email.value.trim(),r=basicForm.password.value.trim(),s=basicForm.status.value.trim(),n={name:t,surname:a,email:i,password:r,status:s};res=await fetch(basicForm.action,{method:e,body:JSON.stringify(n),headers:{"Content-type":"application/json"}}).then(async e=>{let t=await e.json();showAlert(t.message,t.key,!0),200==e.status&&location.reload()})}catch(o){return o}},socialMediaFormCreateUpdate=async e=>{try{let t=basicForm.name.value.trim(),a=basicForm.linkSlug.value.trim(),i=basicForm.socialMediaId.value.trim(),r=basicForm.status.value.trim(),s={name:t,linkSlug:a,socialMediaId:i,status:r};res=await fetch(basicForm.action,{method:e,body:JSON.stringify(s),headers:{"Content-type":"application/json"}}).then(async e=>{let t=await e.json();showAlert(t.message,t.key,!0),200==e.status&&location.reload()})}catch(n){return n}};if(basicForm&&basicForm.addEventListener("submit",async e=>{e.preventDefault();let t=basicForm.action.includes("create")?"POST":"PUT",a=basicForm.action.includes("news"),i=basicForm.action.includes("social_media"),r=basicForm.action.includes("user");a&&await newsFormCreateUpdate(t),r&&await userFormCreateUpdate(t),i&&await socialMediaFormCreateUpdate(t),await itemFormCreateUpdate(t)}),deleteForm&&deleteForm.addEventListener("submit",async e=>{e.preventDefault();try{res=await fetch(deleteForm.action,{method:"DELETE"}).then(async e=>{let t=await e.json();showAlert(t.message,t.key,!0),200==e.status&&location.reload()})}catch(t){return t}}),"/admin/news"===window.location.pathname){let e=document.getElementById("category"),t=document.getElementById("subCategory"),a=document.querySelector("#news-items"),i=document.getElementById("paginationNews"),r=document.querySelector("#searchForm"),s=30,n=1,o=document.getElementById("userMetaKeywords");async function c(e,t){try{let i=await fetch(e),r=await i.json();if(i.ok){let{news:s,totalPages:n,totalCount:o}=r;p(o),o>0?(l(s,t),g(n)):a.innerHTML='<tr><td colspan="6">Hal-hazırda he\xe7 bir xəbər materialı əldə olunmadı.</td></tr>'}else displayAlert(r.message,"error");attachEditDeleteEventListeners()}catch(c){console.error("Error fetching news items:",c)}}function l(e,t){let i=1;a.innerHTML="",e.forEach(e=>{let r=`<tr><td><span class="fw-medium">${t?t++:i++}</span></td><td class="text-wrap">${e.title}</td><td>${d(e.category)}</td><td class="text-wrap">${m(e.news_tags)}</td><td>${u(e.status)}</td><td>${b(e)}</td></tr>`;a.innerHTML+=r})}function d(e){return e?e.name+(e.status?'<i class="bx bx-check-circle" style="color: #198754;"></i>':'<i class="bx bx-x-circle" style="color: #ED4337"></i>'):'Təyin edilmədi<i class="bx bx-x-circle" style="color: #ED4337"></i>'}function m(e){return e.length>0?e.map(e=>e&&e.tag?`<span class="badge bg-label-success me-1">${e.tag.name}</span>`:"").join(""):""}function u(e){return e?'<span class="badge bg-label-primary me-1">Aktiv</span>':'<span class="badge bg-label-danger me-1">Passiv</span>'}function b(e){return`<div class="dropdown"><button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown"><i class="bx bx-dots-vertical-rounded"></i></button><div class="dropdown-menu"><a class="dropdown-item editBtn" href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#basicModal" data-action="/admin/edit-news?id=${e.id}" data-id="${e.id}" data-item="news"><i class="bx bx-edit-alt me-1"></i> D\xfczəlt</a><a class="dropdown-item deleteBtn" href="javascript:void(0);" data-action="/admin/delete-news?id=${e.id}" data-bs-toggle="modal" data-bs-target="#deleteModal" data-item="news"><i class="bx bx-trash me-1"></i> Sil</a><a class="dropdown-item" href="/news/news-detail?key=${e.key}"><i class='bx bx-link-alt'></i> Xəbərə get</a></div></div>`}function g(e,t){let a="";for(let r=1;r<=e;r++)a+=`<li class="page-item ${r===n?"active":""}"><a class="page-link" href="/admin/news/load-more?key=${t}&startIndex=${(r-1)*s}&limit=${s}">${r}</a></li>`;i.innerHTML=a}function p(e){let t=document.querySelector("#totalCount");t.innerHTML=e}o.addEventListener("input",function(e){let t=this.selectionStart,a=this.value,i=a.lastIndexOf("  ");if(-1!==i&&0!==i&&i!==a.length-2){let r=a.slice(0,i)+","+a.slice(i+1).trim();this.value=r,this.setSelectionRange(t,t)}}),e.addEventListener("change",async function(){let e=this.value;if(t.innerHTML="<option selected hidden disabled> Se\xe7im edin </option>",e)try{let a=await fetch(`/admin/get-subCategories?categoryId=${e}`),i=await a.json();a.ok?i.forEach(e=>{let a=document.createElement("option");a.value=e.id,a.textContent=e.name,t.appendChild(a)}):showAlert(i.message,i.key,!0)}catch(r){showAlert(r.message,"error",!0)}}),i.addEventListener("click",e=>{e.preventDefault();let t=1;if(e.target.classList.contains("page-link")&&!e.target.parentElement.classList.contains("disabled")){let a=e.target.getAttribute("href"),i=Number(e.target.textContent);if(i===n)return;n=i,a.includes("startIndex=0")?(itemCounter=1,t=1):t=(i-1)*s+1,c(a,t)}}),r&&r.addEventListener("submit",async e=>{e.preventDefault(),itemCounter=0;try{let t=r.input.value.trim(),i=changeLetters(t.toLowerCase()),n=`/admin/news/search?key=${i}&startIndex=0&limit=${s}`;a.innerHTML="",""==i||void 0==i||null==i?c(`/admin/news/load-more?key=undefined&startIndex=0&limit=${s}`):await c(n,0,i)}catch(o){console.error("Error performing search:",o)}}),c(`/admin/news/load-more?key=undefined&startIndex=0&limit=${s}`)}